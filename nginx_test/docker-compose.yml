# Docker Compose for Nginx Test Environment
# Complete stack for local development and testing

version: '3.8'

services:
  # ============================================
  # NGINX LOAD BALANCER
  # ============================================
  nginx:
    build:
      context: ./nginx
      dockerfile: docker/Dockerfile
    container_name: nginx-lb
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/config/proxy_params:/etc/nginx/proxy_params:ro
    depends_on:
      - was-1-tomcat
      - was-2-tomcat
      - was-3-springboot
      - was-4-springboot
      - was-5-nodejs
      - was-6-nodejs
      - was-7-flask
      - was-8-go
    networks:
      nginx-test-net:
        ipv4_address: 172.30.0.10
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # WAS 1,2: TOMCAT (Legacy On-Premise Simulation)
  # ============================================
  was-1-tomcat:
    build:
      context: ./was-1-tomcat
      dockerfile: docker/Dockerfile
    container_name: was-1-tomcat
    ports:
      - "8081:8080"
    networks:
      nginx-test-net:
        ipv4_address: 172.30.1.1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  was-2-tomcat:
    build:
      context: ./was-2-tomcat
      dockerfile: docker/Dockerfile
    container_name: was-2-tomcat
    ports:
      - "8082:8080"
    networks:
      nginx-test-net:
        ipv4_address: 172.30.1.2
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # WAS 3,4: SPRING BOOT
  # ============================================
  was-3-springboot:
    build:
      context: ./was-3-springboot
      dockerfile: docker/Dockerfile
    container_name: was-3-springboot
    ports:
      - "8083:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=development
      - REDIS_NODES=redis-1:6379,redis-2:6379,redis-3:6379
      - KAFKA_BROKERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=was-3-springboot
    networks:
      nginx-test-net:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  was-4-springboot:
    build:
      context: ./was-4-springboot
      dockerfile: docker/Dockerfile
    container_name: was-4-springboot
    ports:
      - "8084:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=development
      - REDIS_NODES=redis-1:6379,redis-2:6379,redis-3:6379
      - KAFKA_BROKERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=was-4-springboot
    networks:
      nginx-test-net:

  # ============================================
  # WAS 5,6: NODE.JS
  # ============================================
  was-5-nodejs:
    build:
      context: ./was-5-nodejs
      dockerfile: docker/Dockerfile
    container_name: was-5-nodejs
    ports:
      - "3001:3000"
    environment:
      - NODE_ENV=production
      - REDIS_NODES=redis-1:6379,redis-2:6379,redis-3:6379
      - KAFKA_BROKERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      - OTEL_SERVICE_NAME=was-5-nodejs
      - LOKI_URL=http://loki:3100
    networks:
      nginx-test-net:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  was-6-nodejs:
    build:
      context: ./was-6-nodejs
      dockerfile: docker/Dockerfile
    container_name: was-6-nodejs
    ports:
      - "3002:3000"
    environment:
      - NODE_ENV=production
      - REDIS_NODES=redis-1:6379,redis-2:6379,redis-3:6379
      - KAFKA_BROKERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318
      - OTEL_SERVICE_NAME=was-6-nodejs
    networks:
      nginx-test-net:

  # ============================================
  # WAS 7: FLASK + GUNICORN
  # ============================================
  was-7-flask:
    build:
      context: ./was-7-flask
      dockerfile: docker/Dockerfile
    container_name: was-7-flask
    ports:
      - "5001:5000"
    environment:
      - REDIS_NODES=redis-1:6379,redis-2:6379,redis-3:6379
      - KAFKA_BROKERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=was-7-flask
      - GUNICORN_WORKERS=4
    networks:
      nginx-test-net:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # WAS 8: GO FIBER
  # ============================================
  was-8-go:
    build:
      context: ./was-8-go
      dockerfile: docker/Dockerfile
    container_name: was-8-go
    ports:
      - "8001:8000"
    environment:
      - REDIS_NODES=redis-1:6379,redis-2:6379,redis-3:6379
      - KAFKA_BROKERS=kafka-1:9092,kafka-2:9092,kafka-3:9092
      - OTEL_EXPORTER_OTLP_ENDPOINT=jaeger:4317
      - OTEL_SERVICE_NAME=was-8-go
    networks:
      nginx-test-net:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  nginx-test-net:
    external: true

volumes:
  prometheus-data:
  grafana-data:
  jaeger-data:
  loki-data:
